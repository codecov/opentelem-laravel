# laravel-codecov-opentelemetry

_Note: This is a work in progress project and is currently not recommended for use by anyone._

## Purpose

This library aims to make interfacing with Codecov's open telemetry based projects more straightforward for Laravel based applications. It is currently pre-alpha and not recommended for use.

This package is not intended to be a general integration library for open telemetry, zipkin, etc. If you're looking for a more general opentelemetry integration package for Laravel, we currently recommended the package that inspired this one by GitHub user SeanHood, found here: https://github.com/SeanHood/laravel-opentelemetry

## Installation

Bring into your project using Composer as follows:

```
composer require codecov/laravel-codecov-opentelemetry
```

## Configuration

This package provides a configuration file that can be published via 

```
php artisan vendor:publish
```

and selecting the `Codecov\\LaravelCodecovOpenTelemetry` package from the list that appears. 

The following settings are available:

| name           | default | description                                                            |
|----------------|---------|------------------------------------------------------------------------|
| ip             | false   | Requester's IP address.                                                |
| path           | true    | Path requested.                                                        |
| url            | true    | Full URL requested.                                                    |
| method         | true    | HTTP method of the request.                                            |
| secure         | false   | Whether the request has been secured with SSL/TLS.                     |
| ua             | false   | Requester's user agent.                                                |
| user           | false   | Authenticated username.                                                |
| action         | true    | Controller action for request if available.                            |
| server         | false   | Request server if available.                                           |
| environment    | true    | The execution environment.                                             |
| release_id     | true    | A unique id for the release being measured, e.g. semver or commit SHA. |
| line_execution | false   | Report lines executed. Requires pcov extension.                        |

## Optional: Line Execution

It's possible to collect and report line coverage using this package. However, to do so, the [pcov](https://github.com/krakjoe/pcov) extension must be loaded into your php installation. 

There are many ways to do this, the following shows a Dockerfile instruction that installs the pcov extension using [pickle](https://github.com/FriendsOfPHP/pickle) in an Alpine Docker image:

```
FROM alpine:3.14

RUN apk update && apk upgrade && \
    #...your dependencies here
    php8-dev gcc make

# Symling php8 => php
RUN ln -s /usr/bin/php8 /usr/bin/php
RUN ln -s /usr/bin/phpize8 /usr/bin/phpize
RUN ln -s /usr/bin/php-config8 /usr/bin/php-config

# Install pcov
RUN wget https://github.com/FriendsOfPHP/pickle/releases/download/v0.6.0/pickle.phar && mv pickle.phar /usr/local/bin/pickle && chmod +x /usr/local/bin/pickle
RUN pickle install pcov
RUN echo "extension=pcov.so" > /etc/php8/conf.d/php-ext-pcov.ini
RUN echo "pcov.enable=1" >> /etc/php8/conf.d/php-ext-pcov.ini
```

While this shows one example, the basic steps are as follows:

1. Install the relevant system level dependencies for php and pickle
2. Symlink your php version to the canonical defaults (if required)
3. Install pickle
4. Instal pcov via pickle
5. Enable the pcov extension via `.ini` configuration.

Once the pcov extension is properly installed, it can be used by setting:

```
    'tags' => [
        'line_execution' => true, 
    ],
```

in this package's published config file (`config/laravel-codecov-opentelemetry.php`).

### Line Execution Performance Implications

Using line execution in a production system does incur a performance penalty. However, given the lightweight and performant nature of `pcov`, this penalty may be fairly negligible depending on your use case. 

A rough benchmark using Apache Benchmark was generated by visiting the `/login` endpoint of the following application: https://github.com/eliatcodecov/todo. Apache Benchmark was provided via a [Dockerized implementation](https://hub.docker.com/r/jordi/ab) and was executed with the following command:

```
docker run --rm jordi/ab -v 2 -n 100 -c 10 http://<path-to-application></path-to-application>/login
```

This command was run against the same application with pcov line execution enabled and disabled. Results are as follows:

| metric                   | pcov disabled | pcov enabled |
|--------------------------|---------------|--------------|
| Time taken for tests (s) | 2.46          | 2.63         |
| Requests per second      | 40.55         | 37.98        |
| Time per request (ms)    | 24.6          | 26.3         |

